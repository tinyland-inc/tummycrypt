name: CI

on:
  push:
    branches: [main, dev, "sid/**", "1-*"]
  pull_request:
    branches: [main, dev]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Build + Lint + Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            protobuf-compiler \
            libfuse3-dev \
            pkg-config \
            libssl-dev

      - name: cargo fmt
        run: cargo fmt --all -- --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets

      - name: cargo test
        run: cargo test --workspace

      - name: Build workspace (default features)
        run: cargo build --workspace

      - name: Build tcfsd (k8s-worker feature)
        run: cargo build -p tcfsd --features k8s-worker

      - name: Build tcfs CLI (no FUSE â€” macOS/Windows compat)
        run: cargo build -p tcfs-cli --no-default-features

  nix:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            extra-substituters = https://nix-cache.fuzzy-dev.tinyland.dev/main
            extra-trusted-public-keys = main:NKRk1XYo/dfd9fcDqgotUJg2DTDHWp5ny+Ba7WzRjgE=

      - name: Nix flake check
        run: nix flake check

      - name: Build all packages
        run: nix build .#tcfsd .#tcfs-cli .#tcfs-tui .#tcfs-mcp

  deny:
    name: cargo-deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4 | sed 's/^v//')
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | sudo tar xz -C /usr/local/bin gitleaks
      - name: Scan for secrets
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            gitleaks detect --source . --config .gitleaks.toml --log-opts="${{ github.event.pull_request.base.sha }}..HEAD" --verbose
          else
            gitleaks detect --source . --config .gitleaks.toml --verbose
          fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      checks: write
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
