# GitLab CI — secondary pipeline for tinyland-inc mirror
#
# This runs on the GitLab mirror (gitlab.com/tinyland-inc/tummycrypt).
# Primary CI is on GitHub Actions. This provides:
#   - Build verification on GitLab shared runners
#   - Container image push to GitLab Container Registry
#   - Integration with existing tinyland infrastructure

stages:
  - check
  - build
  - publish

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  CARGO_TERM_COLOR: always

# ── Cache ───────────────────────────────────────────────────────────────────

.rust-cache:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry
      - .cargo/git
      - target/
    policy: pull-push

# ── Check (lint + test) ────────────────────────────────────────────────────

check:
  stage: check
  image: rust:1.93-slim-bookworm
  extends: .rust-cache
  before_script:
    - apt-get update -qq && apt-get install -y --no-install-recommends
        protobuf-compiler pkg-config libssl-dev libfuse3-dev
  script:
    - cargo fmt --all -- --check
    - cargo clippy --workspace --all-targets
    - cargo test --workspace
    - cargo build --workspace
    - cargo build -p tcfsd --features k8s-worker
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ── Build container image ───────────────────────────────────────────────────

build-image:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
        --context "${CI_PROJECT_DIR}"
        --dockerfile "${CI_PROJECT_DIR}/Containerfile"
        --destination "${CI_REGISTRY_IMAGE}/tcfsd:${CI_COMMIT_TAG:-latest}"
        --destination "${CI_REGISTRY_IMAGE}/tcfsd:${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
