# .envrc - direnv configuration for tummycrypt/tcfs
# See: https://direnv.net/
#
# This file is evaluated as bash by direnv, then the resulting environment
# is translated to your shell (fish, zsh, bash, etc.) automatically.
#
# First time setup:
#   1. cp .env.example .env
#   2. Edit .env with your credentials
#   3. direnv allow
#
# The Nix devShell provides: rust toolchain, protobuf, age, sops, opentofu,
# kubectl, helm, go-task, cargo-watch, cargo-deny, cargo-audit, natscli, etc.

# ── Nix devShell ─────────────────────────────────────────────────────────────
# nix-direnv (v3.0.6 via Home Manager) caches the devShell evaluation,
# so subsequent cd's into this directory are near-instant.

if has nix; then
  use flake
else
  log_status "Nix not found -- falling back to system toolchain"
  log_status "Install Nix for the full devShell: https://nixos.org/download"

  # Ensure cargo is in PATH (Rocky Linux 10 installs to ~/.cargo/bin)
  PATH_add "${HOME}/.cargo/bin"

  # Warn about missing tools that the Nix devShell would provide
  for cmd in cargo sops age task; do
    if ! has "$cmd"; then
      log_error "Missing: $cmd (would be provided by 'nix develop')"
    fi
  done
fi

# ── Secrets (.env) ───────────────────────────────────────────────────────────
# .env is gitignored. It holds credentials that should never be committed.
# See .env.example for the template.

if [[ -f .env ]]; then
  dotenv .env
else
  log_status "No .env file found. Copy .env.example to .env and fill in values."
  log_status "  cp .env.example .env"
fi

# ── Project configuration ────────────────────────────────────────────────────

# tcfs config file location (daemon + CLI both read this)
export TCFS_CONFIG="${TCFS_CONFIG:-${PWD}/config/tcfs.example.toml}"

# Rust logging for development (respects RUST_LOG if already set in .env)
export RUST_LOG="${RUST_LOG:-tcfsd=debug,tcfs=debug,tcfs_core=debug,tcfs_storage=info,tcfs_sync=debug,tower=warn}"

# Show backtraces on panic (development convenience)
export RUST_BACKTRACE="${RUST_BACKTRACE:-1}"

# SOPS age key file (standard location, set by sops-init.sh)
export SOPS_AGE_KEY_FILE="${SOPS_AGE_KEY_FILE:-${HOME}/.config/sops/age/keys.txt}"

# ── Local dev stack defaults ─────────────────────────────────────────────────
# These are used by docker-compose and by the CLI when talking to local services.
# Override in .env for non-default values.

# SeaweedFS S3 endpoint (local docker-compose stack)
export TCFS_S3_ENDPOINT="${TCFS_S3_ENDPOINT:-http://localhost:8333}"

# NATS JetStream endpoint (local docker-compose stack)
export TCFS_NATS_URL="${TCFS_NATS_URL:-nats://localhost:4222}"

# Prometheus metrics bind address (daemon)
export TCFS_METRICS_ADDR="${TCFS_METRICS_ADDR:-127.0.0.1:9100}"

# ── Docker / Podman ──────────────────────────────────────────────────────────
# Uncomment if using podman as docker replacement:
# export DOCKER_HOST="unix://${XDG_RUNTIME_DIR}/podman/podman.sock"

# Compose project name (keeps volumes/networks namespaced)
export COMPOSE_PROJECT_NAME="${COMPOSE_PROJECT_NAME:-tcfs}"
